export interface FallbackSeedFile {
  path: string;
  content: string;
  fileCategory: string;
}

const architectureNotes = "# with.md Architecture Notes\n\nwith.md enables markdown collaboration for people and agents.\n\n## Workflow\n\n1. Open file in read mode.\n2. Enter rich edit mode when syntax is supported.\n3. Fall back to source mode when unsupported.\n";

const agentsFile = "# AGENTS\n\nAgent instructions here.\n";

const finalImplementationPlan = "# with.md â€” Final Implementation Plan (Web UI MVP)\n\n## 1. Objective\nBuild a desktop-first web UI for filesystem-first markdown collaboration that is:\n- Beautiful and calm (editorial, cinematic, graceful).\n- Fast in read mode, collaborative in rich-text edit mode.\n- Safe for real-world markdown with an always-editable Source mode.\n- Compatible with git-first backend semantics (manual push, re-sync, low-noise diffs).\n\nThis plan is designed for one-pass agentic execution by Codex/Claude Code.\n\n## 2. Locked Decisions\nThese are fixed and implemented as constraints:\n- Source mode is editable.\n- Approximate comment recovery is acceptable when CRDT anchors are unavailable.\n- Unsupported markdown syntax may fall back to Source mode.\n- MVP can be desktop-first (no full responsive polish required).\n- One global visual theme for MVP.\n\n## 3. MVP Scope\nIn scope:\n- File list + document page with three modes:\n  - `Read` (rendered markdown, no Hocuspocus connection)\n  - `Edit` (TipTap + Yjs + Hocuspocus)\n  - `Source` (editable markdown)\n- Anchored comments with sidebar threads.\n- Approximate anchor recovery strategy.\n- Manual `Push to GitHub` and `Re-sync` actions.\n- Activity feed panel and unpushed changes badge.\n- Syntax safety gate (supported -> Edit allowed; unsupported -> Source default).\n\nOut of scope for MVP:\n- Full mobile UX parity.\n- PR/branch workflows.\n- Perfect round-trip fidelity for every markdown dialect.\n- Rich MDX/custom directive visual editing.\n\n## 4. Product Behavior (User Flows)\n### 4.1 Open a file\n1. User opens markdown file.\n2. App renders `Read` mode immediately from backend markdown string.\n3. App shows comments in sidebar (using best-known anchor data).\n4. App runs syntax compatibility check.\n\n### 4.2 Enter rich collaborative editing\n1. User clicks editor surface or `Edit` toggle.\n2. If syntax supported, app initializes Yjs + IndexedDB + Hocuspocus + TipTap.\n3. User edits with presence cursors.\n4. Debounced persistence updates backend markdown + Yjs state.\n\n### 4.3 Enter Source mode\n1. User toggles `Source`.\n2. Source textarea/CodeMirror is editable.\n3. User can `Apply to doc` (for supported files) or `Save source` (unsupported files).\n4. For supported files, apply action reparses markdown into TipTap doc.\n\n### 4.4 Add comment\n1. User selects text in Edit mode.\n2. App sets custom comment mark with `commentMarkId`.\n3. App stores metadata in backend with anchor snapshot.\n4. Sidebar updates in realtime.\n\n### 4.5 Recover comments after CRDT reset\n1. If mark missing, app attempts reattach using quote/context/heading/line heuristics.\n2. If not found, comment still shows in sidebar with approximate location.\n\n## 5. Frontend Architecture\n## 5.1 State machine\nUse a strict UI mode state:\n\n```ts\ntype DocMode = 'read' | 'edit' | 'source';\n\ninterface DocState {\n  mode: DocMode;\n  syntaxSupported: boolean;\n  hasDirtySourceBuffer: boolean;\n  collabConnected: boolean;\n}\n```\n\nRules:\n- `read -> edit` only if `syntaxSupported === true`.\n- `read -> source` always allowed.\n- `source` is always editable.\n- `edit <-> source` allowed, but source changes require explicit apply/save action.\n\n## 5.2 Global visual theme\nUse one theme matching the provided mood and screenshot:\n- Background image: `background_0.jpeg` (default global).\n- Dark translucent content card.\n- Serif heading for document title and section heads.\n- Sans for UI controls.\n- Low-saturation accent colors for comments/activity badges.\n\n## 5.3 Data boundaries\nFrontend only depends on explicit backend contracts:\n- File content and metadata.\n- Comments CRUD + suggestions + activity feed.\n- Collaboration auth/load/store/disconnect endpoints for Hocuspocus.\n- Push/re-sync actions.\n\nNo frontend assumptions about git internals.\n\n## 6. Backend Contract (Frontend-facing)\nUse Convex functions directly in the web app (HTTP only for Hocuspocus hooks):\n\n```ts\n// Queries\nrepos.list()\nrepos.get({ repoId })\nmdFiles.listByRepo({ repoId, includeDeleted: false })\nmdFiles.get({ mdFileId })\nmdFiles.resolveByPath({ repoId, path })\ncomments.listByFile({ mdFileId })\nsuggestions.listByFile({ mdFileId })\nactivities.listByRepo({ repoId, cursor? })\npushQueue.unpushedCount({ repoId })\n\n// Mutations\ncomments.create({ mdFileId, body, commentMarkId, textQuote, anchorPrefix, anchorSuffix, anchorHeadingPath, fallbackLine })\ncomments.update({ commentId, body })\ncomments.resolve({ commentId })\ncomments.delete({ commentId, commentMarkId, mdFileId })\nmdFiles.saveSource({ mdFileId, sourceContent })\nsuggestions.create({ mdFileId, originalText, suggestedText, baseContentHash })\nsuggestions.accept({ suggestionId })\nsuggestions.reject({ suggestionId })\nrepos.resync({ repoId })\npushQueue.pushNow({ repoId })\nactivities.markAsRead({ repoId })\n\n// Hocuspocus HTTP hooks (internal)\nPOST /api/collab/authenticate\nPOST /api/collab/loadDocument\nPOST /api/collab/storeDocument\nPOST /api/collab/onAllDisconnected\n```\n\n## 7. File Plan (Web App)\nCreate this module inside existing Next app:\n\n```text\nweb/src/app/(authenticated)/with-md/page.tsx\nweb/src/app/(authenticated)/with-md/[repoId]/[...filePath]/page.tsx\n\nweb/src/components/with-md/with-md-shell.tsx\nweb/src/components/with-md/file-tree.tsx\nweb/src/components/with-md/document-toolbar.tsx\nweb/src/components/with-md/document-surface.tsx\nweb/src/components/with-md/read-renderer.tsx\nweb/src/components/with-md/source-editor.tsx\nweb/src/components/with-md/collab-editor.tsx\nweb/src/components/with-md/comments-sidebar.tsx\nweb/src/components/with-md/activity-panel.tsx\nweb/src/components/with-md/presence-strip.tsx\n\nweb/src/components/with-md/tiptap/comment-mark.ts\nweb/src/components/with-md/tiptap/editor-extensions.ts\n\nweb/src/hooks/with-md/use-doc-mode.ts\nweb/src/hooks/with-md/use-collab-doc.ts\nweb/src/hooks/with-md/use-comment-anchors.ts\nweb/src/hooks/with-md/use-syntax-support.ts\n\nweb/src/lib/with-md/api.ts\nweb/src/lib/with-md/types.ts\nweb/src/lib/with-md/convex-functions.ts\nweb/src/lib/with-md/syntax.ts\nweb/src/lib/with-md/anchor.ts\nweb/src/lib/with-md/markdown-diff.ts\n\nweb/src/styles/with-md.css\nweb/public/with-md/backgrounds/background_0.jpeg\n```\n\n## 8. Dependencies\nFrom `web/`:\n\n```bash\nnpm i @tiptap/core @tiptap/react @tiptap/starter-kit @tiptap/markdown @tiptap/extension-collaboration @tiptap/extension-collaboration-cursor @hocuspocus/provider yjs y-indexeddb\n```\n\nOptional (if needed for source editor quality):\n\n```bash\nnpm i @uiw/react-codemirror\n```\n\n## 9. Core Data Types\n\n```ts\nexport interface MdFile {\n  mdFileId: string;\n  repoId: string;\n  path: string;\n  content: string;\n  contentHash: string;\n  fileCategory: 'readme' | 'prompt' | 'agent' | 'claude' | 'docs' | 'other';\n  editHeartbeat?: number;\n  pendingGithubContent?: string;\n  isDeleted?: boolean;\n  deletedAt?: number;\n  syntaxSupportStatus?: 'unknown' | 'supported' | 'unsupported';\n  syntaxSupportReasons?: string[];\n}\n\nexport interface CommentAnchorSnapshot {\n  commentMarkId: string;\n  textQuote: string;\n  prefix: string;\n  suffix: string;\n  headingPath: string[];\n  fallbackLine: number;\n}\n\nexport interface CommentRecord {\n  id: string;\n  mdFileId: string;\n  authorId: string;\n  body: string;\n  resolvedAt?: number;\n  resolvedBy?: string;\n  parentCommentId?: string;\n  anchor: CommentAnchorSnapshot;\n}\n```\n\n## 10. Syntax Safety Gate\nImplement deterministic safety detection before enabling TipTap Edit mode.\n\n```ts\nconst FRONTMATTER_RE = /^---\\n[\\s\\S]*?\\n---\\n/;\nconst MDX_RE = /<\\w+[\\s\\S]*?>|\\{[^\\n]*\\}/;\nconst DIRECTIVE_RE = /^:{2,}\\w+/m;\n\nexport function detectUnsupportedSyntax(md: string): {\n  supported: boolean;\n  reasons: string[];\n} {\n  const reasons: string[] = [];\n\n  if (FRONTMATTER_RE.test(md)) reasons.push('frontmatter');\n  if (DIRECTIVE_RE.test(md)) reasons.push('directives');\n  if (MDX_RE.test(md)) reasons.push('mdx_or_embedded_jsx');\n\n  return {\n    supported: reasons.length === 0,\n    reasons,\n  };\n}\n```\n\nBehavior:\n- `supported=true`: user can choose Read/Edit/Source.\n- `supported=false`: default to Source with non-blocking warning banner.\n- Backend should persist parse compatibility (`syntaxSupportStatus`) so UI can skip repeated expensive checks.\n\n## 11. TipTap Comment Mark (Custom)\nUse custom mark, not TipTap Comments extension, to avoid markdown-conversion fragility.\n\n```ts\nimport { Mark } from '@tiptap/core';\n\nexport const CommentMark = Mark.create({\n  name: 'comment',\n  inclusive: false,\n  addAttributes() {\n    return {\n      commentMarkId: { default: null },\n    };\n  },\n  parseHTML() {\n    return [{ tag: 'span[data-comment-id]' }];\n  },\n  renderHTML({ HTMLAttributes }) {\n    return [\n      'span',\n      {\n        'data-comment-id': HTMLAttributes.commentMarkId,\n        class: 'withmd-comment-highlight',\n      },\n      0,\n    ];\n  },\n});\n```\n\n## 12. Collab Hook (Yjs + Hocuspocus + IndexedDB)\n\n```ts\nexport function useCollabDoc(params: {\n  mdFileId: string;\n  token: string;\n  user: { name: string; color: string };\n  enabled: boolean;\n}) {\n  const ydoc = useMemo(() => new Y.Doc(), [params.mdFileId]);\n\n  useEffect(() => {\n    if (!params.enabled) return;\n    const persistence = new IndexeddbPersistence(`withmd-${params.mdFileId}`, ydoc);\n    return () => persistence.destroy();\n  }, [params.enabled, params.mdFileId, ydoc]);\n\n  const provider = useMemo(() => {\n    if (!params.enabled) return null;\n    return new HocuspocusProvider({\n      url: process.env.NEXT_PUBLIC_HOCUSPOCUS_URL!,\n      name: params.mdFileId,\n      document: ydoc,\n      token: params.token,\n    });\n  }, [params.enabled, params.mdFileId, params.token, ydoc]);\n\n  return { ydoc, provider };\n}\n```\n\n## 13. Source Mode (Editable)\nFor MVP simplicity and safety:\n- Source mode has its own editable buffer.\n- Changes are explicit via buttons.\n- No hidden autosync between source textarea and live TipTap doc.\n\nButtons:\n- `Apply to Edit Doc` (supported files, reparses markdown into TipTap content).\n- `Save Source` (uses `mdFiles.saveSource`, writes markdown directly to Convex and queues push item).\n- `Discard Source Changes`.\n\n## 14. Comment Anchor Snapshot + Recovery\nWhen creating comment, capture:\n- selected quote\n- 32-char prefix and suffix context\n- heading path at selection\n- fallback line number\n\nRecovery order:\n1. Find exact `textQuote` unique match.\n2. If multiple matches, score by prefix/suffix proximity.\n3. If no match, restrict search to `headingPath` section and retry.\n4. If still not found, place sidebar link using `fallbackLine`.\n\nPseudo-code:\n\n```ts\nexport function recoverAnchor(md: string, anchor: CommentAnchorSnapshot): {start: number; end: number} | null {\n  const exactMatches = findAllIndices(md, anchor.textQuote);\n  if (exactMatches.length === 1) return span(exactMatches[0], anchor.textQuote.length);\n\n  if (exactMatches.length > 1) {\n    const scored = exactMatches\n      .map((i) => ({ i, score: contextScore(md, i, anchor.prefix, anchor.suffix) }))\n      .sort((a, b) => b.score - a.score);\n    return span(scored[0].i, anchor.textQuote.length);\n  }\n\n  const section = findSectionByHeadingPath(md, anchor.headingPath);\n  if (section) {\n    const j = section.indexOf(anchor.textQuote);\n    if (j >= 0) return span(section.start + j, anchor.textQuote.length);\n  }\n\n  return null;\n}\n```\n\n## 15. Markdown Fidelity Guard (Client + Backend)\nRules:\n- Preserve original markdown when there is no meaningful semantic change.\n- Prevent noisy diffs from pure serializer normalization.\n\nImplement helper:\n\n```ts\nexport function hasMeaningfulDiff(nextMd: string, prevMd: string): boolean {\n  const normalize = (s: string) =>\n    s\n      .replace(/\\r\\n/g, '\\n')\n      .replace(/[ \\t]+$/gm, '')\n      .replace(/__([^_]+)__/g, '**$1**')\n      .trim();\n\n  return normalize(nextMd) !== normalize(prevMd);\n}\n```\n\nUse this guard before patching canonical `mdFile.content`.\n\n## 16. UI Composition\nLayout (desktop-first):\n- Full-screen scenic background + dark vignette overlay.\n- Center document panel (`max-width: 940px`) with glass effect.\n- Right sidebar for comments/activity.\n- Compact top toolbar with mode toggle + push/resync status.\n\nStyle tokens (`web/src/styles/with-md.css`):\n\n```css\n:root {\n  --withmd-bg-overlay: rgba(10, 16, 18, 0.68);\n  --withmd-panel: rgba(12, 14, 18, 0.82);\n  --withmd-border: rgba(255, 255, 255, 0.14);\n  --withmd-text: rgba(245, 247, 250, 0.94);\n  --withmd-muted: rgba(210, 216, 224, 0.72);\n  --withmd-comment: rgba(255, 209, 102, 0.28);\n}\n\n.withmd-bg {\n  background-image: linear-gradient(var(--withmd-bg-overlay), var(--withmd-bg-overlay)), url('/with-md/backgrounds/background_0.jpeg');\n  background-size: cover;\n  background-position: center;\n}\n\n.withmd-panel {\n  background: var(--withmd-panel);\n  border: 1px solid var(--withmd-border);\n  backdrop-filter: blur(3px);\n}\n```\n\n## 17. Implementation Steps (One-pass Order)\nExecute in this order:\n\n1. Create module skeleton files listed in Section 7.\n2. Add dependencies (Section 8).\n3. Copy `with-md/backgrounds/background_0.jpeg` to `web/public/with-md/backgrounds/`.\n4. Build shell (`with-md-shell.tsx`) + toolbar + file tree placeholders.\n5. Implement read renderer (react-markdown + remark-gfm).\n6. Implement syntax safety hook (`detectUnsupportedSyntax`).\n7. Implement Source editor (editable + save/apply/discard).\n8. Implement collab hook + TipTap editor + presence.\n9. Implement custom comment mark + selection-to-comment flow.\n10. Implement comments sidebar and click linking.\n11. Implement approximate anchor recovery utilities.\n12. Wire push/resync buttons and activity panel.\n13. Add fidelity guard helper and hook into save paths.\n14. Integrate Convex queries/mutations and remove temporary mocks.\n15. Add test suite and run checks.\n\n## 18. Acceptance Criteria\nFunctional:\n- File opens in read mode instantly.\n- Source mode is always editable.\n- Supported files can enter collaborative edit mode with cursors.\n- Unsupported files open in source mode with warning and can still be edited/saved.\n- Comments can be created from selected text and shown in sidebar.\n- After synthetic anchor loss, at least one recovery strategy resolves most comments.\n- Push/resync actions visible and invokable.\n\nQuality:\n- No crashes when switching modes repeatedly.\n- No data loss in browser refresh while editing (IndexedDB recovery).\n- Noise-only markdown changes are reduced by meaningful-diff guard.\n\n## 19. Testing Plan\nUnit tests:\n- `syntax.ts`: markdown feature detection.\n- `anchor.ts`: quote/context/heading-based recovery logic.\n- `markdown-diff.ts`: semantic-diff guard.\n\nIntegration tests (component-level):\n- mode transitions `read -> edit -> source -> edit`.\n- source apply flow updates editor document.\n- comment create and sidebar highlight linking.\n\nManual checks:\n- Open 10 representative markdown docs.\n- Verify supported vs unsupported routing.\n- Verify comment behavior with and without active collab session.\n- Verify push and resync button states.\n\n## 20. Risks and Mitigations\nRisk: TipTap markdown conversion normalizes formatting.\nMitigation: semantic-diff guard + source mode fallback.\n\nRisk: comment marks lost after Yjs reset.\nMitigation: approximate anchor recovery using quote/context/heading/line.\n\nRisk: unsupported syntax silently mangled.\nMitigation: preflight syntax gate and source-default behavior.\n\nRisk: source/edit mode conflicts.\nMitigation: explicit apply/save actions; avoid hidden dual-write behavior.\n\n## 21. Deliverables\nAt end of one-pass implementation, agent should produce:\n- Working `/with-md` route in `web` app.\n- Read/Edit/Source modes with required behavior.\n- Comment sidebar with anchored mark flow.\n- Global visual theme matching provided direction.\n- Tests passing for core utilities and mode transitions.\n\n## 22. References\n- TipTap Markdown docs: https://tiptap.dev/docs/editor/markdown\n- TipTap Markdown custom serialization: https://tiptap.dev/docs/editor/markdown/advanced-usage/custom-serializing\n- TipTap comments overview: https://tiptap.dev/docs/comments/getting-started/overview\n- Peritext paper: https://www.inkandswitch.com/peritext/\n- Loro rich text article: https://loro.dev/blog/loro-richtext\n";

const pasteSmokeTest = "# Paste Smoke Test\n\nThis file is intentionally simple.\n\nPaste markdown from Cursor here to validate:\n- copy/paste fidelity\n- read rendering\n- source persistence after refresh\n";

export const fallbackSeedFiles: FallbackSeedFile[] = [
  { path: 'docs/with-md-architecture.md', content: architectureNotes, fileCategory: 'docs' },
  { path: 'docs/with-md-final-implementation-plan.md', content: finalImplementationPlan, fileCategory: 'docs' },
  { path: 'docs/paste-smoke-test.md', content: pasteSmokeTest, fileCategory: 'docs' },
  { path: 'AGENTS.md', content: agentsFile, fileCategory: 'agent' },
];
